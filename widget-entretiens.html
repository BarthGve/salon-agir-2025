<!DOCTYPE html>
<html lang="fr" data-fr-scheme="system">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comptes Rendus Entretiens - Salon Agir 2025</title>
    <!-- DSFR CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.12.1/dist/dsfr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.12.1/dist/utility/icons/icons.min.css">
    <!-- Quill WYSIWYG Editor -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <style>
        .widget-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        .selector-section {
            margin: 2rem 0;
        }
        .header-entretien {
            margin-bottom: 1.5rem;
        }
        .meta-info {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: var(--background-alt-grey);
            border-radius: 8px;
        }
        .section-content {
            white-space: pre-line;
            line-height: 1.6;
        }
        .fr-tabs__panel {
            padding-top: 1.5rem;
        }
        /* Fix hauteur des onglets pour s'adapter au contenu */
        .fr-tabs {
            height: auto !important;
        }
        .fr-tabs__panel--selected {
            height: auto !important;
            max-height: none !important;
            overflow: visible !important;
            padding-bottom: 2rem;
        }
        .company-card,
        .participants-grid {
            padding-bottom: 1rem;
        }
        .company-card {
            display: grid;
            gap: 1rem;
        }
        .company-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .company-logo {
            width: 64px;
            height: 64px;
            border-radius: 8px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .company-logo img {
            max-width: 50px;
            max-height: 50px;
            object-fit: contain;
        }
        .company-logo .initials {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-mention-grey);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        .stat-item {
            background: var(--background-alt-grey);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-title-grey);
        }
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-mention-grey);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .solutions-list, .clients-list {
            display: grid;
            gap: 0.75rem;
        }
        .solution-item, .client-item {
            background: var(--background-alt-grey);
            padding: 1rem;
            border-radius: 8px;
        }
        .solution-name, .client-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .solution-desc, .client-project {
            font-size: 0.875rem;
            color: var(--text-mention-grey);
        }
        /* Cartes d'identite participants */
        .participants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }
        .participant-card {
            background: white;
            border: 1px solid var(--border-default-grey);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .participant-card__header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: var(--background-alt-blue-france);
            border-bottom: 1px solid var(--border-default-grey);
        }
        .participant-card__photo {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .participant-card__photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .participant-card__photo .initials {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-action-high-blue-france);
        }
        .participant-card__identity {
            flex: 1;
            min-width: 0;
        }
        .participant-card__name {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-title-grey);
            margin: 0 0 0.25rem 0;
        }
        .participant-card__fonction {
            font-size: 0.875rem;
            color: var(--text-mention-grey);
            margin: 0;
        }
        .participant-card__body {
            padding: 1.25rem 1.5rem;
        }
        .participant-card__field {
            margin-bottom: 0.75rem;
        }
        .participant-card__field:last-child {
            margin-bottom: 0;
        }
        .participant-card__label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-mention-grey);
            margin-bottom: 0.25rem;
        }
        .participant-card__value {
            font-size: 0.875rem;
            color: var(--text-default-grey);
            line-height: 1.4;
        }
        .participant-card__footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-default-grey);
            background: var(--background-alt-grey);
        }
        .no-participants {
            text-align: center;
            padding: 3rem;
            background: var(--background-alt-grey);
            border-radius: 8px;
        }
        /* Liens interlocuteurs cliquables */
        .interlocuteur-link {
            color: var(--text-action-high-blue-france);
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }
        .interlocuteur-link:hover {
            text-decoration: underline;
            color: var(--text-active-blue-france);
        }
        /* Bouton d'edition */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }
        .btn-edit {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            color: var(--text-action-high-blue-france);
            transition: background-color 0.2s;
        }
        .btn-edit:hover {
            background: var(--background-alt-blue-france);
        }
        /* Modal editeur */
        .editor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .editor-modal.active {
            display: flex;
        }
        .editor-modal__content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        .editor-modal__header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-default-grey);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .editor-modal__title {
            margin: 0;
            font-size: 1.25rem;
        }
        .editor-modal__body {
            padding: 1.5rem;
            flex: 1;
            overflow-y: auto;
        }
        .editor-modal__footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-default-grey);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        #quill-editor {
            height: 300px;
        }
        .ql-editor {
            font-size: 1rem;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- Header DSFR -->
    <header role="banner" class="fr-header">
        <div class="fr-header__body">
            <div class="fr-container">
                <div class="fr-header__body-row">
                    <div class="fr-header__brand fr-enlarge-link">
                        <div class="fr-header__brand-top">
                            <div class="fr-header__logo">
                                <p class="fr-logo">
                                    Republique
                                    <br>Francaise
                                </p>
                            </div>
                            <div class="fr-header__operator">
                                <img src="https://cdn.prod.website-files.com/633a90b21badd95ceee55695/633a9420a4808c1a0bbb23ed_Rencontres%20AGIR.png" class="fr-responsive-img" alt="Rencontres AGIR" style="max-height: 42px;">
                            </div>
                        </div>
                        <div class="fr-header__service">
                            <a href="#" title="Accueil">
                                <p class="fr-header__service-title">Salon Agir 2025</p>
                            </a>
                            <p class="fr-header__service-tagline">Comptes rendus d'entretiens</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main role="main" class="fr-py-4w">
        <div class="widget-container">

            <!-- Selecteur d'entretien -->
            <div class="selector-section">
                <div class="fr-select-group">
                    <label class="fr-label" for="entretienSelect">
                        Choisir un entretien
                        <span class="fr-hint-text">Selectionnez un entretien pour afficher le compte rendu</span>
                    </label>
                    <select class="fr-select" id="entretienSelect">
                        <option value="" selected disabled>Selectionnez un entretien...</option>
                    </select>
                </div>
            </div>

            <!-- Etat vide par defaut -->
            <div id="emptyState" class="empty-state">
                <span class="fr-icon-file-text-line fr-icon--lg" aria-hidden="true"></span>
                <h3 class="fr-h4 fr-mt-2w">Aucun entretien selectionne</h3>
                <p class="fr-text--sm fr-text--muted">Utilisez le selecteur ci-dessus pour afficher un compte rendu</p>
            </div>

            <!-- Contenu principal -->
            <div id="mainContent" style="display: none;">
                <!-- En-tete -->
                <div class="header-entretien">
                    <div class="meta-info">
                        <p class="fr-badge fr-badge--blue-ecume" id="badgeDate"></p>
                    </div>
                    <h1 class="fr-h3" id="titreEntretien">Entretien</h1>
                </div>

                <!-- Systeme d'onglets DSFR -->
                <div class="fr-tabs">
                    <ul class="fr-tabs__list" role="tablist" aria-label="Onglets entretien">
                        <li role="presentation">
                            <button id="tabpanel-cr" class="fr-tabs__tab" tabindex="0" role="tab" aria-selected="true" aria-controls="tabpanel-cr-panel">
                                Compte rendu
                            </button>
                        </li>
                        <li role="presentation">
                            <button id="tabpanel-entreprise" class="fr-tabs__tab" tabindex="-1" role="tab" aria-selected="false" aria-controls="tabpanel-entreprise-panel">
                                Fiche entreprise
                            </button>
                        </li>
                        <li role="presentation">
                            <button id="tabpanel-participants" class="fr-tabs__tab" tabindex="-1" role="tab" aria-selected="false" aria-controls="tabpanel-participants-panel">
                                <span id="tabLabelInterlocuteurs">Interlocuteur</span>
                            </button>
                        </li>
                    </ul>

                    <!-- Panel Compte Rendu -->
                    <div id="tabpanel-cr-panel" class="fr-tabs__panel fr-tabs__panel--selected" role="tabpanel" aria-labelledby="tabpanel-cr" tabindex="0">

                        <!-- Interlocuteurs -->
                        <div class="fr-mb-3w">
                            <p class="fr-text">
                                <strong id="interlocuteursLabel">Interlocuteur :</strong> <span id="participantsEntreprise">-</span>
                            </p>
                        </div>

                        <!-- Accordeons pour les sections -->
                        <div class="fr-accordions-group">
                            <!-- Contexte -->
                            <section class="fr-accordion">
                                <h3 class="fr-accordion__title">
                                    <button class="fr-accordion__btn" aria-expanded="true" aria-controls="accordion-contexte">
                                        Contexte de l'entretien
                                    </button>
                                </h3>
                                <div class="fr-collapse" id="accordion-contexte">
                                    <div class="section-header">
                                        <div id="contexteContent" class="section-content">-</div>
                                        <button class="btn-edit" onclick="openEditor('Contexte', 'contexteContent', 'Contexte')" title="Modifier">
                                            <span class="fr-icon-edit-line" aria-hidden="true"></span>
                                        </button>
                                    </div>
                                </div>
                            </section>

                            <!-- Solutions proposees -->
                            <section class="fr-accordion">
                                <h3 class="fr-accordion__title">
                                    <button class="fr-accordion__btn" aria-expanded="false" aria-controls="accordion-solutions">
                                        Solutions proposees
                                    </button>
                                </h3>
                                <div class="fr-collapse" id="accordion-solutions">
                                    <div class="section-header">
                                        <div id="solutionsContent" class="section-content">-</div>
                                        <button class="btn-edit" onclick="openEditor('Solutions proposees', 'solutionsContent', 'Solutions_Proposees')" title="Modifier">
                                            <span class="fr-icon-edit-line" aria-hidden="true"></span>
                                        </button>
                                    </div>
                                </div>
                            </section>

                            <!-- Cas d'usage -->
                            <section class="fr-accordion">
                                <h3 class="fr-accordion__title">
                                    <button class="fr-accordion__btn" aria-expanded="false" aria-controls="accordion-usages">
                                        Cas d'usage discutes
                                    </button>
                                </h3>
                                <div class="fr-collapse" id="accordion-usages">
                                    <div class="section-header">
                                        <div id="usagesContent" class="section-content">-</div>
                                        <button class="btn-edit" onclick="openEditor('Cas d\'usage discutes', 'usagesContent', 'Cas_Usage_Discutes')" title="Modifier">
                                            <span class="fr-icon-edit-line" aria-hidden="true"></span>
                                        </button>
                                    </div>
                                </div>
                            </section>

                            <!-- Points cles -->
                            <section class="fr-accordion">
                                <h3 class="fr-accordion__title">
                                    <button class="fr-accordion__btn" aria-expanded="false" aria-controls="accordion-points">
                                        Points cles
                                    </button>
                                </h3>
                                <div class="fr-collapse" id="accordion-points">
                                    <div class="section-header">
                                        <div id="pointsClesContent" class="section-content">-</div>
                                        <button class="btn-edit" onclick="openEditor('Points cles', 'pointsClesContent', 'Points_Cles')" title="Modifier">
                                            <span class="fr-icon-edit-line" aria-hidden="true"></span>
                                        </button>
                                    </div>
                                </div>
                            </section>
                        </div>

                        <!-- Prochaines etapes -->
                        <div class="fr-callout fr-callout--green-emeraude fr-mt-3w">
                            <div class="section-header">
                                <h4 class="fr-callout__title" style="margin: 0;">Prochaines etapes envisagees</h4>
                                <button class="btn-edit" onclick="openEditor('Prochaines etapes', 'prochainesEtapesContent', 'Prochaines_Etapes')" title="Modifier">
                                    <span class="fr-icon-edit-line" aria-hidden="true"></span>
                                </button>
                            </div>
                            <div id="prochainesEtapesContent" class="fr-callout__text section-content">-</div>
                        </div>
                    </div>

                    <!-- Panel Fiche Entreprise -->
                    <div id="tabpanel-entreprise-panel" class="fr-tabs__panel" role="tabpanel" aria-labelledby="tabpanel-entreprise" tabindex="0">
                        <div class="company-card">
                            <!-- Header entreprise -->
                            <div class="company-header">
                                <div class="company-logo" id="companyLogo">
                                    <span class="initials" id="companyInitials">?</span>
                                </div>
                                <div>
                                    <h2 class="fr-h4 fr-mb-0" id="companyName">-</h2>
                                    <p class="fr-badge fr-badge--sm fr-badge--blue-ecume" id="companySector">-</p>
                                </div>
                            </div>

                            <!-- Description -->
                            <p id="companyDescription" class="fr-text">-</p>

                            <!-- Liens -->
                            <div class="fr-btns-group fr-btns-group--inline">
                                <a id="companyWebsite" class="fr-btn fr-btn--secondary fr-btn--icon-left fr-icon-global-line" href="#" target="_blank" style="display:none;">
                                    Site web
                                </a>
                                <a id="companyLinkedIn" class="fr-btn fr-btn--tertiary fr-btn--icon-left fr-icon-linkedin-box-fill" href="#" target="_blank" style="display:none;">
                                    LinkedIn
                                </a>
                            </div>

                            <!-- Stats -->
                            <div class="stats-grid" id="statsGrid">
                                <div class="stat-item">
                                    <div class="stat-value" id="statCreation">-</div>
                                    <div class="stat-label">Creation</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="statEffectifs">-</div>
                                    <div class="stat-label">Effectifs</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="statSiege">-</div>
                                    <div class="stat-label">Siege</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="statCA">-</div>
                                    <div class="stat-label">CA</div>
                                </div>
                            </div>

                            <!-- Solutions de l'entreprise -->
                            <h3 class="fr-h5">Solutions</h3>
                            <div class="solutions-list" id="solutionsList">
                                <p class="fr-text--muted">Aucune solution referencee</p>
                            </div>

                            <!-- Clients references -->
                            <h3 class="fr-h5 fr-mt-3w">Clients references</h3>
                            <div class="clients-list" id="clientsList">
                                <p class="fr-text--muted">Aucun client reference</p>
                            </div>
                        </div>
                    </div>

                    <!-- Panel Interlocuteurs -->
                    <div id="tabpanel-participants-panel" class="fr-tabs__panel" role="tabpanel" aria-labelledby="tabpanel-participants" tabindex="0">
                        <h2 class="fr-h4 fr-mb-3w" id="panelTitleInterlocuteurs">Interlocuteur de l'entretien</h2>
                        <div class="participants-grid" id="participantsGrid">
                            <div class="no-participants">
                                <span class="fr-icon-user-line fr-icon--lg" aria-hidden="true"></span>
                                <p class="fr-mt-2w fr-text--muted">Aucun interlocuteur pour cet entretien</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Editeur WYSIWYG -->
    <div id="editorModal" class="editor-modal">
        <div class="editor-modal__content">
            <div class="editor-modal__header">
                <h3 class="editor-modal__title" id="editorTitle">Modifier la section</h3>
                <button class="fr-btn--close fr-btn" title="Fermer" onclick="closeEditor()">
                    Fermer
                </button>
            </div>
            <div class="editor-modal__body">
                <div id="quill-editor"></div>
            </div>
            <div class="editor-modal__footer">
                <button class="fr-btn fr-btn--secondary" onclick="closeEditor()">
                    Annuler
                </button>
                <button class="fr-btn" onclick="saveContent()">
                    Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- Footer DSFR -->
    <footer class="fr-footer" role="contentinfo" id="footer">
        <div class="fr-container">
            <div class="fr-footer__bottom">
                <ul class="fr-footer__bottom-list">
                    <li class="fr-footer__bottom-item">
                        <span class="fr-footer__bottom-link">Salon Agir 2025 - Montrouge</span>
                    </li>
                </ul>
                <div class="fr-footer__bottom-copy">
                    <p>Widget Grist - Comptes rendus d'entretiens</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Grist Plugin API -->
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <!-- DSFR JS -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.12.1/dist/dsfr.module.min.js"></script>
    <!-- Quill WYSIWYG Editor -->
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>

    <script>
        // Donnees
        let entretiens = [];
        let entreprises = [];
        let participants = [];
        let solutions = [];
        let clients = [];
        let currentEntretien = null;
        let currentEntreprise = null;
        let isGristMode = false;

        // Config Grist
        const GRIST_BASE_URL = 'https://grist.numerique.gouv.fr';
        const GRIST_DOC_ID = 'qZyF674ZEUb3';

        // Formater une date Unix timestamp
        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp * 1000);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
        }

        // Obtenir les initiales
        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
        }

        // Extraire les IDs d'une RefList Grist (format: ["L", id1, id2, ...])
        function extractRefListIds(refList) {
            if (!refList) return [];
            if (Array.isArray(refList) && refList[0] === 'L') {
                return refList.slice(1);
            }
            if (typeof refList === 'number') return [refList];
            return [];
        }

        // Resoudre les noms des participants depuis leurs IDs
        function resolveParticipantNames(refList, type) {
            const ids = extractRefListIds(refList);
            if (ids.length === 0) return { count: 0, html: 'Non renseigne' };

            const filteredParticipants = ids
                .map(id => participants.find(p => p.id === id))
                .filter(p => p && (!type || p.type === type));

            if (filteredParticipants.length === 0) return { count: 0, html: 'Non renseigne' };

            const links = filteredParticipants.map(p => {
                const nom = [p.prenom, p.nom].filter(Boolean).join(' ');
                const displayName = p.fonction ? `${nom} (${p.fonction})` : nom;
                return `<a href="#" class="interlocuteur-link" onclick="navigateToInterlocuteurs(); return false;">${displayName}</a>`;
            });

            return { count: filteredParticipants.length, html: links.join(', ') };
        }

        // Naviguer vers l'onglet Interlocuteurs
        function navigateToInterlocuteurs() {
            const tabButton = document.getElementById('tabpanel-participants');
            if (tabButton) {
                tabButton.click();
            }
        }

        // Charger une table via l'API REST Grist (mode standalone)
        async function fetchGristTableREST(tableName) {
            try {
                const url = `${GRIST_BASE_URL}/api/docs/${GRIST_DOC_ID}/tables/${tableName}/records`;
                const response = await fetch(url);
                if (!response.ok) {
                    console.error(`Erreur API Grist pour ${tableName}: ${response.status}`);
                    return [];
                }
                const data = await response.json();
                if (!data.records) return [];
                return data.records.map(r => ({ id: r.id, ...r.fields }));
            } catch (e) {
                console.error('Erreur chargement table ' + tableName + ':', e);
                return [];
            }
        }

        // Charger une table via l'API Widget Grist (mode integre)
        async function fetchGristTableWidget(tableName) {
            try {
                const data = await grist.docApi.fetchTable(tableName);
                if (!data || !data.id) return [];
                const records = [];
                const numRecords = data.id.length;
                const columns = Object.keys(data);
                for (let i = 0; i < numRecords; i++) {
                    const record = { id: data.id[i] };
                    columns.forEach(col => {
                        if (col !== 'id') {
                            record[col] = data[col][i];
                        }
                    });
                    records.push(record);
                }
                return records;
            } catch (e) {
                console.error('Erreur chargement table ' + tableName + ':', e);
                return [];
            }
        }

        // Charger une table (detecte automatiquement le mode)
        async function fetchGristTable(tableName) {
            if (isGristMode) {
                return await fetchGristTableWidget(tableName);
            } else {
                return await fetchGristTableREST(tableName);
            }
        }

        // Charger toutes les donnees
        async function loadAllData() {
            try {
                // Entreprises
                const entreprisesData = await fetchGristTable('Entreprises');
                entreprises = entreprisesData.map(r => ({
                    id: r.id,
                    nom: r.nom || '',
                    description: r.Description || '',
                    siteWeb: r.SiteWeb || '',
                    logoURL: r.LogoURL || '',
                    dateCreation: r.DateCreation || '',
                    effectifs: r.Effectifs || '',
                    siege: r.Siege || '',
                    secteur: r.Secteur || '',
                    ca: r.CA || '',
                    linkedInURL: r.LinkedInURL || ''
                }));

                // Participants
                const participantsData = await fetchGristTable('Participants');
                participants = participantsData.map(r => ({
                    id: r.id,
                    nom: r.Nom || '',
                    prenom: r.Prenom || '',
                    type: r.Type || '',
                    entreprise: r.Entreprise,
                    fonction: r.Fonction || '',
                    email: r.Email || '',
                    telephone: r.Telephone || '',
                    linkedin: r.LinkedIn || '',
                    formation: r.Formation || '',
                    parcours: r.Parcours || '',
                    localisation: r.Localisation || '',
                    photoURL: r.Photo_URL || ''
                }));

                // Entretiens
                const entretiensData = await fetchGristTable('Entretiens');
                entretiens = entretiensData.map(r => ({
                    id: r.id,
                    Date: r.Date,
                    Entreprise: r.Entreprise,
                    Participants_Equipe: r.Participants_Equipe,
                    Participants_Entreprise: r.Participants_Entreprise,
                    Contexte: r.Contexte || '',
                    Solutions_Proposees: r.Solutions_Proposees || '',
                    Cas_Usage_Discutes: r.Cas_Usage_Discutes || '',
                    Points_Cles: r.Points_Cles || '',
                    Prochaines_Etapes: r.Prochaines_Etapes || ''
                }));

                // Solutions (Table1)
                const solutionsData = await fetchGristTable('Table1');
                solutions = solutionsData.map(r => ({
                    entreprise: r.Entreprise,
                    nom: r.NomSolution || '',
                    description: r.Description || '',
                    type: r.TypeIA || ''
                }));

                // Clients
                const clientsData = await fetchGristTable('Clients');
                clients = clientsData.map(r => ({
                    entreprise: parseInt(r.Entreprise) || r.Entreprise,
                    nom: r.NomClient || '',
                    projet: r.TypeProjet || ''
                }));

                console.log('Donnees chargees:', entreprises.length, 'entreprises,', participants.length, 'participants,', entretiens.length, 'entretiens');

                // Remplir le selecteur
                populateSelect();

            } catch (e) {
                console.error('Erreur chargement donnees:', e);
            }
        }

        // Remplir le selecteur d'entretiens
        function populateSelect() {
            const select = document.getElementById('entretienSelect');
            select.innerHTML = '<option value="" selected disabled>Selectionnez un entretien...</option>';

            entretiens.forEach(e => {
                const entreprise = entreprises.find(ent => ent.id === e.Entreprise);
                const entrepriseNom = entreprise ? entreprise.nom : 'Entreprise inconnue';
                const dateStr = formatDate(e.Date);

                const option = document.createElement('option');
                option.value = e.id;
                option.textContent = `${entrepriseNom} - ${dateStr}`;
                select.appendChild(option);
            });
        }

        // Afficher un entretien
        function displayEntretien(record) {
            if (!record) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
                return;
            }

            currentEntretien = record;

            // Trouver l'entreprise liee
            const entrepriseId = record.Entreprise;
            currentEntreprise = entreprises.find(e => e.id === entrepriseId);
            const entrepriseNom = currentEntreprise ? currentEntreprise.nom : 'Entreprise inconnue';

            // Afficher le contenu principal
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

            // En-tete
            document.getElementById('badgeDate').textContent = formatDate(record.Date);
            document.getElementById('titreEntretien').textContent = 'Entretien avec ' + entrepriseNom;

            // Interlocuteurs (resolus depuis RefList) avec liens cliquables
            const interlocuteurs = resolveParticipantNames(record.Participants_Entreprise, 'Entreprise');
            document.getElementById('participantsEntreprise').innerHTML = interlocuteurs.html;

            // Gestion singulier/pluriel pour "Interlocuteur(s)"
            const isPlural = interlocuteurs.count > 1;
            const labelText = isPlural ? 'Interlocuteurs :' : 'Interlocuteur :';
            const tabText = isPlural ? 'Interlocuteurs' : 'Interlocuteur';
            const panelTitleText = isPlural ? 'Interlocuteurs de l\'entretien' : 'Interlocuteur de l\'entretien';

            document.getElementById('interlocuteursLabel').textContent = labelText;
            document.getElementById('tabLabelInterlocuteurs').textContent = tabText;
            document.getElementById('panelTitleInterlocuteurs').textContent = panelTitleText;

            // Sections (innerHTML pour supporter le formatage HTML)
            document.getElementById('contexteContent').innerHTML = record.Contexte || '-';
            document.getElementById('solutionsContent').innerHTML = record.Solutions_Proposees || '-';
            document.getElementById('usagesContent').innerHTML = record.Cas_Usage_Discutes || '-';
            document.getElementById('pointsClesContent').innerHTML = record.Points_Cles || '-';
            document.getElementById('prochainesEtapesContent').innerHTML = record.Prochaines_Etapes || '-';

            // Mettre a jour la fiche entreprise
            if (currentEntreprise) {
                displayEntreprise(currentEntreprise);
            }

            // Mettre a jour les participants
            displayParticipants(record);
        }

        // Afficher la fiche entreprise
        function displayEntreprise(company) {
            if (!company) return;

            // Nom et secteur
            document.getElementById('companyName').textContent = company.nom;
            document.getElementById('companySector').textContent = company.secteur || 'Non categorise';
            document.getElementById('companyDescription').textContent = company.description || 'Aucune description disponible.';

            // Logo
            const logoContainer = document.getElementById('companyLogo');
            if (company.logoURL && !company.logoURL.includes('favicon')) {
                logoContainer.innerHTML = '<img src="' + company.logoURL + '" alt="' + company.nom + '" onerror="this.parentElement.innerHTML=\'<span class=initials>' + getInitials(company.nom) + '</span>\'">';
            } else {
                logoContainer.innerHTML = '<span class="initials">' + getInitials(company.nom) + '</span>';
            }

            // Liens
            const websiteBtn = document.getElementById('companyWebsite');
            const linkedinBtn = document.getElementById('companyLinkedIn');

            if (company.siteWeb) {
                websiteBtn.href = company.siteWeb;
                websiteBtn.style.display = 'inline-flex';
            } else {
                websiteBtn.style.display = 'none';
            }

            if (company.linkedInURL) {
                linkedinBtn.href = company.linkedInURL;
                linkedinBtn.style.display = 'inline-flex';
            } else {
                linkedinBtn.style.display = 'none';
            }

            // Stats
            document.getElementById('statCreation').textContent = company.dateCreation || '-';
            document.getElementById('statEffectifs').textContent = company.effectifs || '-';
            document.getElementById('statSiege').textContent = company.siege || '-';
            document.getElementById('statCA').textContent = company.ca || '-';

            // Solutions de l'entreprise
            const companySolutions = solutions.filter(s => s.entreprise === company.id);
            const solutionsList = document.getElementById('solutionsList');

            if (companySolutions.length > 0) {
                solutionsList.innerHTML = companySolutions.map(s => `
                    <div class="solution-item">
                        <div class="solution-name">${s.nom}</div>
                        <div class="solution-desc">${s.description}</div>
                        ${s.type ? '<span class="fr-badge fr-badge--sm fr-badge--blue-cumulus">' + s.type + '</span>' : ''}
                    </div>
                `).join('');
            } else {
                solutionsList.innerHTML = '<p class="fr-text--muted">Aucune solution referencee</p>';
            }

            // Clients (gerer string ou number pour entreprise)
            const companyClients = clients.filter(c => parseInt(c.entreprise) === company.id || c.entreprise === company.id);
            const clientsList = document.getElementById('clientsList');

            if (companyClients.length > 0) {
                clientsList.innerHTML = companyClients.map(c => `
                    <div class="client-item">
                        <div class="client-name">${c.nom}</div>
                        <div class="client-project">${c.projet}</div>
                    </div>
                `).join('');
            } else {
                clientsList.innerHTML = '<p class="fr-text--muted">Aucun client reference</p>';
            }
        }

        // Afficher les participants entreprise de l'entretien
        function displayParticipants(record) {
            const grid = document.getElementById('participantsGrid');

            // Recuperer les IDs des participants entreprise
            const participantIds = extractRefListIds(record.Participants_Entreprise);

            if (participantIds.length === 0) {
                grid.innerHTML = `
                    <div class="no-participants">
                        <span class="fr-icon-user-line fr-icon--lg" aria-hidden="true"></span>
                        <p class="fr-mt-2w fr-text--muted">Aucun interlocuteur pour cet entretien</p>
                    </div>
                `;
                return;
            }

            // Filtrer les participants de type Entreprise
            const entrepriseParticipants = participantIds
                .map(id => participants.find(p => p.id === id))
                .filter(p => p && p.type === 'Entreprise');

            if (entrepriseParticipants.length === 0) {
                grid.innerHTML = `
                    <div class="no-participants">
                        <span class="fr-icon-user-line fr-icon--lg" aria-hidden="true"></span>
                        <p class="fr-mt-2w fr-text--muted">Aucun interlocuteur pour cet entretien</p>
                    </div>
                `;
                return;
            }

            // Generer les cartes
            grid.innerHTML = entrepriseParticipants.map(p => {
                const fullName = [p.prenom, p.nom].filter(Boolean).join(' ') || 'Participant';
                const initials = getInitials(fullName);
                const company = entreprises.find(e => e.id === p.entreprise);
                const companyName = company ? company.nom : '';

                // Photo ou initiales
                const photoHtml = p.photoURL
                    ? `<img src="${p.photoURL}" alt="${fullName}" onerror="this.parentElement.innerHTML='<span class=initials>${initials}</span>'">`
                    : `<span class="initials">${initials}</span>`;

                // Construction des champs
                let fieldsHtml = '';

                if (companyName) {
                    fieldsHtml += `
                        <div class="participant-card__field">
                            <div class="participant-card__label">Entreprise</div>
                            <div class="participant-card__value">${companyName}</div>
                        </div>
                    `;
                }

                if (p.formation) {
                    fieldsHtml += `
                        <div class="participant-card__field">
                            <div class="participant-card__label">Formation</div>
                            <div class="participant-card__value">${p.formation}</div>
                        </div>
                    `;
                }

                if (p.parcours) {
                    fieldsHtml += `
                        <div class="participant-card__field">
                            <div class="participant-card__label">Parcours</div>
                            <div class="participant-card__value">${p.parcours}</div>
                        </div>
                    `;
                }

                if (p.localisation) {
                    fieldsHtml += `
                        <div class="participant-card__field">
                            <div class="participant-card__label">Localisation</div>
                            <div class="participant-card__value">${p.localisation}</div>
                        </div>
                    `;
                }

                // Footer avec LinkedIn
                let footerHtml = '';
                if (p.linkedin) {
                    footerHtml = `
                        <div class="participant-card__footer">
                            <a href="${p.linkedin}" target="_blank" class="fr-btn fr-btn--secondary fr-btn--sm fr-btn--icon-left fr-icon-linkedin-box-fill">
                                Voir le profil LinkedIn
                            </a>
                        </div>
                    `;
                }

                return `
                    <div class="participant-card">
                        <div class="participant-card__header">
                            <div class="participant-card__photo">
                                ${photoHtml}
                            </div>
                            <div class="participant-card__identity">
                                <h3 class="participant-card__name">${fullName}</h3>
                                ${p.fonction ? `<p class="participant-card__fonction">${p.fonction}</p>` : ''}
                            </div>
                        </div>
                        ${fieldsHtml ? `<div class="participant-card__body">${fieldsHtml}</div>` : ''}
                        ${footerHtml}
                    </div>
                `;
            }).join('');
        }

        // Event listener pour le selecteur
        document.getElementById('entretienSelect').addEventListener('change', function() {
            const id = parseInt(this.value);
            if (id) {
                const entretien = entretiens.find(e => e.id === id);
                if (entretien) {
                    displayEntretien(entretien);
                }
            }
        });

        // Initialisation
        async function init() {
            // Detecter si on est dans Grist
            const isInGristIframe = window.self !== window.top && typeof grist !== 'undefined';

            if (isInGristIframe) {
                // Mode integre Grist
                isGristMode = true;
                console.log('Mode Grist Widget detecte');

                grist.ready({ requiredAccess: 'full' });

                await loadAllData();

                // Ecouter les selections dans Grist
                grist.onRecord(function(record) {
                    console.log('Record selectionne:', record);
                    if (record && record.id) {
                        // Chercher l'entretien dans notre tableau mappe
                        const entretien = entretiens.find(e => e.id === record.id);
                        if (entretien) {
                            // Mettre a jour le selecteur
                            document.getElementById('entretienSelect').value = record.id;
                            displayEntretien(entretien);
                        }
                    }
                });
            } else {
                // Mode standalone
                isGristMode = false;
                console.log('Mode standalone - chargement via API REST');

                await loadAllData();
            }
        }

        // ========================================
        // EDITEUR WYSIWYG
        // ========================================

        let quillEditor = null;
        let currentEditField = null;
        let currentEditElementId = null;

        // Initialiser Quill
        function initQuill() {
            if (quillEditor) return;

            quillEditor = new Quill('#quill-editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                },
                placeholder: 'Saisissez votre contenu...'
            });
        }

        // Ouvrir l'editeur
        function openEditor(title, elementId, fieldName) {
            if (!currentEntretien) {
                alert('Veuillez d\'abord selectionner un entretien.');
                return;
            }

            // Initialiser Quill si pas encore fait
            initQuill();

            // Stocker les references
            currentEditField = fieldName;
            currentEditElementId = elementId;

            // Mettre a jour le titre
            document.getElementById('editorTitle').textContent = 'Modifier : ' + title;

            // Recuperer le contenu actuel
            const currentContent = document.getElementById(elementId).innerHTML;

            // Charger dans Quill
            quillEditor.root.innerHTML = currentContent === '-' ? '' : currentContent;

            // Afficher le modal
            document.getElementById('editorModal').classList.add('active');

            // Focus sur l'editeur
            quillEditor.focus();
        }

        // Fermer l'editeur
        function closeEditor() {
            document.getElementById('editorModal').classList.remove('active');
            currentEditField = null;
            currentEditElementId = null;
        }

        // Sauvegarder le contenu
        async function saveContent() {
            if (!currentEditField || !currentEditElementId || !currentEntretien) {
                closeEditor();
                return;
            }

            // Recuperer le contenu HTML de Quill
            const htmlContent = quillEditor.root.innerHTML;
            const textContent = quillEditor.getText().trim();

            // Mettre a jour l'affichage local
            document.getElementById(currentEditElementId).innerHTML = textContent ? htmlContent : '-';

            // Sauvegarder dans Grist
            try {
                const recordId = currentEntretien.id;
                const updateData = {};
                updateData[currentEditField] = textContent ? htmlContent : '';

                if (isGristMode) {
                    // Mode widget Grist
                    await grist.docApi.applyUserActions([
                        ['UpdateRecord', 'Entretiens', recordId, updateData]
                    ]);
                    console.log('Sauvegarde Grist reussie');
                } else {
                    // Mode standalone - API REST
                    const url = `${GRIST_BASE_URL}/api/docs/${GRIST_DOC_ID}/tables/Entretiens/records`;
                    const response = await fetch(url, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            records: [{
                                id: recordId,
                                fields: updateData
                            }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Erreur API: ' + response.status);
                    }
                    console.log('Sauvegarde REST reussie');
                }

                // Mettre a jour l'entretien local et dans le tableau
                const newValue = textContent ? htmlContent : '';
                currentEntretien[currentEditField] = newValue;

                // Mettre aussi a jour dans le tableau entretiens
                const entretienIndex = entretiens.findIndex(e => e.id === currentEntretien.id);
                if (entretienIndex !== -1) {
                    entretiens[entretienIndex][currentEditField] = newValue;
                }

                // Fermer le modal
                closeEditor();

            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                alert('Erreur lors de la sauvegarde. Verifiez la console pour plus de details.');
            }
        }

        // Fermer le modal en cliquant a l'exterieur
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('editorModal');
            if (e.target === modal) {
                closeEditor();
            }
        });

        // Fermer avec Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEditor();
            }
        });

        // Demarrer
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
